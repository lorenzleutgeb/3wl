\documentclass{vutinfth} % Remove option 'final' to obtain debug information.

% Load packages to allow in- and output of non-ASCII characters.
\usepackage{lmodern}        % Use an extension of the original Computer Modern font to minimize the use of bitmapped letters.
\usepackage[T1]{fontenc}    % Determines font encoding of the output. Font packages have to be included before this line.
\usepackage[utf8]{inputenc} % Determines encoding of the input. All input files have to use UTF8 encoding.

% Extended LaTeX functionality is enables by including packages with \usepackage{...}.
\usepackage{fixltx2e}   % Provides fixes for several errors in LaTeX2e.
\usepackage{amsmath}    % Extended typesetting of mathematical expression.
\usepackage{amsthm}
\usepackage{amssymb}    % Provides a multitude of mathematical symbols.
\usepackage{mathtools}  % Further extensions of mathematical typesetting.
\usepackage{microtype}  % Small-scale typographic enhancements.
\usepackage{enumitem}   % User control over the layout of lists (itemize, enumerate, description).
\usepackage{multirow}   % Allows table elements to span several rows.
\usepackage{booktabs}   % Improves the typesettings of tables.
\usepackage{subcaption} % Allows the use of subfigures and enables their referencing.
\usepackage[ruled,linesnumbered,algochapter]{algorithm2e} % Enables the writing of pseudo code.
\usepackage[usenames,dvipsnames,table]{xcolor} % Allows the definition and use of colors. This package has to be included before tikz.
\usepackage{nag}       % Issues warnings when best practices in writing LaTeX documents are violated.
\usepackage{hyperref}  % Enables cross linking in the electronic document version. This package has to be included second to last.
\usepackage[acronym,toc]{glossaries} % Enables the generation of glossaries and lists fo acronyms. This package has to be included last.
\usepackage{tikz}
\usetikzlibrary{matrix}
\usetikzlibrary{shapes.multipart,calc}
\usetikzlibrary{positioning}
\usetikzlibrary{fit}

% Define convenience functions to use the author name and the thesis title in the PDF document properties.
\newcommand{\authorname}{Lorenz Leutgeb} % The author name without titles.
\newcommand{\thesistitle}{Efficient propagation for lazy-grounding Answer Set solving} % The title of the thesis. The English version should be used, if it exists.

\hypersetup{
    pdfpagelayout   = TwoPageRight,
    linkbordercolor = {Melon},
    pdfauthor       = {\authorname},
    pdftitle        = {\thesistitle},
    pdfsubject      = {Subject},              % The document's subject in the document properties (optional).
    pdfkeywords     = {asp, solver, propagation, nogood}
}

\setsecnumdepth{subsection} % Enumerate subsections.

\nonzeroparskip             % Create space between paragraphs (optional).
\setlength{\parindent}{0pt} % Remove paragraph identation (optional).

\makeindex      % Use an optional index.
\makeglossaries % Use an optional glossary.
%\glstocfalse   % Remove the glossaries from the table of contents.

% Set persons with 4 arguments:
%  {title before name}{name}{title after name}{gender}
%  where both titles are optional (i.e. can be given as empty brackets {}).
\setauthor{}{\authorname}{}{male}
\setadvisor{Prof.~Dr.}{Thomas Eiter}{}{male}

% For bachelor and master theses:
\setfirstassistant{Dr.}{Antonius Weinzierl}{}{male}
%\setsecondassistant{Pretitle}{Forename Surname}{Posttitle}{male}
%\setthirdassistant{Pretitle}{Forename Surname}{Posttitle}{male}

\setaddress{Engilgasse 3a, 1160 Wien}
\setregnumber{1127842}
\setdate{31}{10}{2016} % Set date with 3 arguments: {day}{month}{year}.
\settitle{\thesistitle}{Efficient propagation for lazy-grounding Answer Set solving} % Sets English and German version of the title (both can be English or German).
%\setsubtitle{Optional Subtitle of the Thesis}{Optionaler Untertitel der Arbeit} % Sets English and German version of the subtitle (both can be English or German).

\setthesis{bachelor}

\setcurriculum{Software \& Information Engineering}{Software \& Information Engineering} % Sets the English and German name of the curriculum.

% Define convenience macros.
\newcommand{\todo}[1]{{\color{red}\textbf{TODO: {#1}}}} % Comment for the final version, to raise errors.

\theoremstyle{example}
\newtheorem{example}{Example}[section]

\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]

\theoremstyle{theorem}
\newtheorem{theorem}{Theorem}[section]

\theoremstyle{lemma}
\newtheorem{lemma}{Lemma}[theorem]

\theoremstyle{corollary}
\newtheorem{corollary}{Corollary}[theorem]

\newtheorem*{remark}{Remark}

\newcommand{\mbt}{must-be-true}
\newcommand{\negstrong}[1]{\overline{#1}^s}
\newcommand{\negweak}[1]{\overline{#1}^w}

% Function B transforming an assignment into a boolean assignment.
\newcommand{\bass}{\mathcal{B}}

% An assignment A.
\newcommand{\ass}{\mathbf{A}}

% Herbrand Base function of some logic program.
\newcommand{\hb}{\textit{HB}}

\newcommand{\bT}{\mathbf{T}}
\newcommand{\bM}{\mathbf{M}}
\newcommand{\bF}{\mathbf{F}}
\newcommand{\bX}{\mathbf{X}}

\newcommand{\sgl}{\mu}
\newcommand{\bsgl}{\sigma}

\newcommand{\thrice}{{\{\bT, \bM, \bF \}}}

\newcommand{\wkn}{\textit{weaken}}

\usepackage{csquotes}

\begin{document}

\frontmatter % Switches to roman numbering.
% The structure of the thesis has to conform to
%  http://www.informatik.tuwien.ac.at/dekanat

\addtitlepage{naustrian}
\addtitlepage{english}
\addstatementpage

\begin{danksagung*}
\todo{Ihr Text hier.}
\end{danksagung*}

\begin{acknowledgements*}
\todo{Enter your text here.}
\end{acknowledgements*}

\begin{kurzfassung}
\todo{Ihr Text hier.}
\end{kurzfassung}

\begin{abstract}
\todo{Enter your text here.}
\end{abstract}

\selectlanguage{english}

\tableofcontents % Starred version, i.e., \tableofcontents*, removes the self-entry.

% Switch to arabic numbering and start the enumeration of chapters in the table of content.
\mainmatter

\chapter{Introduction}

Answer Set Programming (ASP) is a programming paradigm aimed at solving problems by means of declarative and logic programming based on Nonmonotonic Reasoning. 

\section{Motivation}

\section{Problem Statement}

\section{Aim of the Work}

\section{Methodological Approach}

\section{Structure of the Work} % 3 sentences

This is just a test.\cite{Gebser:2012:CAS:2228640.2228952}

\chapter{Preliminaries}
\label{chap:preliminaries}

\section{Answer Set Programming}

% TODO: Introduction to ASP and it's semantics.

\section{State of the Art in ASP Solving}

% Two Watched Literals?

\subsection{Approaches based on Pre-Grounding}

% TODO: Explain how a solver works and what has been done already (grounding on the fly, omiga, asperix).
% TODO: What is a nogood? What is propagation?

% Everything that later sections build up on. Quote a lot. This chapter can be long. Show understanding of the matter in own words (i.e. what is an answer set incl. example?).

\subsection{Approaches based on Lazy Grounding}

\section{Analysis}

\section{Comparison and Summary of Existing Approaches}

\todo{Enter your text here.}

\chapter{Propagation for lazy-grounding Answer Set solving}

This chapter contextualizes propagation by providing definitions extending chapter \ref{chap:preliminaries}. It then presents and thoroughly explains the algorithms and data structures involved in propagation and concludes in a proof of soundness and completeness thereof.

\section{Definitions}

% Signed literal vs. boolean signed literal.

Following definitions lay out the vocabulary and concepts towards an explanation of unit propagation. Most of them fundamentally depend on \emph{atoms} (usually denoted $v$) but do not refer to neither a set of atoms nor their domain. This is because all definitions are bound to a logic program $P$ to be solved (i.e.~to find answer sets for). The set of ground atoms wrt.~$P$, effectively its Herbrand Base $\textit{HB}(P)$, is obtained by the grounding process, which is not detailed in this work. What might seem to be lacking from the definitions therefore is the context of the input program $P$ and therefore the domain of atoms. $P$ and its context is omitted in the following.

% TODO: Where does v come from? Should be in some HB(P)?
%\begin{definition}
%A \emph{ground atom} (or simply \emph{atom}) wrt.~a logic program $P$ is an element of $\textit{HB}(P)$, usually denoted $v$.
%\end{definition}

%\begin{definition}
A \emph{signed literal} $\sgl$ of the form $\mathbf{T}v$, $\mathbf{M}v$ or $\mathbf{F}v$ where $v$ is an atom and $\mathbf{T}v$ expresses that $v$ is \emph{true}, $\mathbf{M}v$ that it \emph{must be true}, and $\mathbf{F}v$ that it is \emph{false}.
%\end{definition}

%\begin{definition}
A \emph{boolean signed literal} $\bsgl$ of the form $\mathbf{T}v$ or $\mathbf{F}v$ where $v$ is an atom and  $\mathbf{T}v$ expresses that $v$ is \emph{true}, and $\mathbf{F}v$ that it is \emph{false}.
%\end{definition}

%\begin{definition}
The function $\wkn(\bsgl)$ takes a boolean signed literal $\bsgl$ and transforms it into a signed literal referred to as its \emph{weak form}, meaning that while \emph{false} stays \emph{false}, e.g.~$\wkn(\bF v) = \bF v$, \emph{true} is mapped to \emph{\mbt}, e.g.~$\wkn(\bT v) = \bM v$.
%\end{definition}

% TODO: Remark on boolean signed literal vs. signed literal with context of clasp?

\begin{definition}
An \emph{assignment} $\ass$ is a sequence $(\sgl_1, \ldots, \sgl_n)$ of signed literals $\sgl_i$ of the form $\bX v_i$ with $\bX \in \thrice$ where $v_i \not = v_j$ for $1 \leq i < j \leq n$, or \emph{conflict}.
%\end{definition}

%\begin{definition}
For every assignment, a respective \emph{boolean assignment}, denoted $\bass(\ass)$ can be constructed by collapsing all atoms that \emph{must be true} to being \emph{true}:$$\bass(\ass) = \{ \sgl \ | \ \sgl \in \ass, \sgl = \mathbf{T}v \textrm{ or } \sgl = \mathbf{F}v \} \cup \{ \bsgl \ | \ \sgl \in \ass, \sgl = \mathbf{M}v, \bsgl = \mathbf{T}v \}$$
\end{definition}

%\begin{remark}
Below, assignments are sometimes also used as sets, in which case the set represented by some assignment is simply the set of all signed literals contained in the sequence.
%\end{remark}

\begin{definition}
Strong complement, denoted by $\negstrong{\sgl}$, and weak complement, $\negweak{\sgl}$, mapping $\mathbf{F}v$ to $\mathbf{T}v$ and $\mathbf{F}v$ to $\mathbf{M}v$ respectively, of a signed literal are defined by the following truth table:%equalities: $\negstrong{\mathbf{T}v} = \mathbf{F}v$, $\negstrong{\mathbf{M}v} = \mathbf{F}v$ and  $\negstrong{\mathbf{F}v} = \mathbf{T}v$, while $\negweak{\mathbf{T}v} = \mathbf{F}v$, $\negweak{\mathbf{M}v} = \mathbf{F}v$ and $\negweak{\mathbf{F}v} = \mathbf{M}v$.
% "andere Richtung auch erklären"

\begin{center}
\begin{tabular}{|c|cc|}
\hline
$\sgl$&$\negstrong{\sgl}$&$\negweak{\sgl}$\\
\hline
\hline
$\mathbf{T}v$&$\mathbf{F}v$&$\mathbf{F}v$\\
$\mathbf{M}v$&$\mathbf{F}v$&$\mathbf{F}v$\\
$\mathbf{F}v$&$\mathbf{T}v$&$\mathbf{M}v$\\
\hline
\end{tabular}
\end{center}
\end{definition}

The assignment obtained by appending the literal $\sgl$ to $\ass$ is denoted by $\ass \circ \sigma$. In case $\negstrong{\sigma} \in \ass \vee \negweak{\sigma} \in \ass$ however, $\ass \circ \sigma =$ \emph{conflict} to indicate that appending $\sigma$ conflicts with other literals in $\ass$. Furthermore $\emph{conflict} \circ \sigma = \emph{conflict}$. To ensure that the assignment contains at most one literal per atom $v$, in case $\mathbf{M}v \in \ass$, then $\mathbf{M}v$ is removed when before $\mathbf{T}v$.

\begin{definition}
An atom $v$ is \emph{unassigned} with respect to some assignment $\ass$ iff $$\ass \cap \{\bT v, \bM v, \bF v \} = \emptyset$$
\end{definition}

\begin{definition}
A signed literal $\bX v$ with $\bX \in \thrice$ is \emph{unassigned} wrt.~$\ass$ if $v$ is unassigned wrt.~$\ass$.
\end{definition}

\begin{definition}
A \emph{nogood} reflects a partial assignment that cannot be extended to a solution. Here, a \emph{nogood} is a set $\{ \bsgl_1, \ldots, \bsgl_n \}$ of signed literals.
\end{definition}

\begin{definition}
A nogood $\delta$ is \emph{violated} by an assignment $\ass$ if $\delta \subseteq \bass(\ass)$.
\end{definition}

\begin{definition}
A nogood $\delta$ is \emph{satisfied} wrt.~some assignment $\ass$ iff there is no $\ass' \supseteq \ass$ s.t.~$\delta$ is violated under $\ass'$.
\end{definition}

\begin{definition}
A nogood is \emph{strictly unit} with respect to some assignment $\ass$ iff it contains exactly one \emph{unassigned} literal and all other literals are elements of $\ass$.
\end{definition}

\begin{definition}
A nogood is \emph{weakly unit} with respect to some assignment $\ass$ iff it contains exactly one \emph{unassigned} literal and all other literals are \emph{weak} elements of $\ass$.
\end{definition}

%To efficiently retrieve the set of nogoods that need to be checked for unity, a data structure of watches was 

Watch structures are sets $\Delta = \{ (v_1, W_1), \ldots, (v_n, W_n) \}$ of pairs $(v_i, W_i)$, $1 \leq i \leq n$, containing an atom $v_i$ and a triple $W_i$, referred to as the \emph{watches for $v_i$}, consisting of $(W_i^+, W_i^-, W_i^\alpha)$, three sets of nogoods that potentially propagate in case the assignment of $v$ changes from \emph{unassigned} to \emph{true} or \emph{\mbt} ($W^+$) or from \emph{unassigned} to \emph{false} ($W^-$), or from \emph{\mbt} to \emph{true} ($W^\alpha$). Also there are no two pairs $(v, W), (v', W') \in \Delta$ s.t.~$v = v'$, i.e.~$\Delta$ is a function mapping an atom to a triple of its watches. We write $\Delta(v) = W$ to denote $(v, W) \in \Delta$. Furthermore, let $\Delta(\sgl) = W^+$ for $\sgl$ of $\bT v$ or $\bM v$ and $\Delta(\sgl) = W^-$ for $\sgl$ of $\bF v$ with $W^+$ and $W^-$ from $\Delta(v)$, i.e.~for signed literals, $\Delta$ is a function that yields the watches according polarity of the literal. Lastly, for some $\sgl = \bX v$ or an atom $v$, let $\Delta^\alpha(v) = W^\alpha$ with $W^\alpha$ via $\Delta(v)$.

\begin{figure}[h]
  \centering
\begin{tikzpicture}[stack/.style={rectangle split, rectangle split parts=#1,draw, anchor=center},->]
\node(s)[stack=4]  {
                 Atom     % text
\nodepart{two}   $v_1$     % two
\nodepart{three} $v_2$      % three
\nodepart{four}  \vdots % four
};

\node(v1t)[stack=3, rectangle split horizontal, above right=2cm and 3cm of s.two] {
$\delta_1$     % two
\nodepart{two} $\delta_2$      % three
\nodepart{three}  \ldots % four
};

\node(v1m)[stack=3, rectangle split horizontal, above right=1cm and 3.5cm of s.two] {
$\delta_3$     % two
\nodepart{two} $\delta_4$      % three
\nodepart{three}  \ldots % four
};

\node(v1f)[stack=3, rectangle split horizontal, above right=0cm and 4cm of s.two] {
$\delta_4$     % two
\nodepart{two} $\delta_5$      % three
\nodepart{three}  \ldots % four
};

\path (s.two east)
edge [out=east,in=west, left] node {$\alpha$} (v1t)
edge [out=east,in=west, above] node {$+$} (v1m)
edge [out=east,in=west, above] node {$-$} (v1f)
;

\end{tikzpicture}
  \caption{The layout of the \emph{watches} data structure $\Delta$.}
  \label{fig:watches} % \label has to be placed AFTER \caption (or \subcaption) to produce correct cross-references.
\end{figure}

\section{Unit Propagation}

\begin{algorithm}
  \SetKw{BreakFor}{break for}
  \KwIn{An assignment $\ass$,
        a~signed~literal~$\sgl$,
        a~watch~structure~$\Delta$.}
  \KwOut{The assignment $\ass$, extended by means of unit propagation and $\Delta$ with updated watches.}
  $\ass \leftarrow \ass \circ \sgl$\\
  $(\ass, \Delta) \leftarrow$ \textsc{UnitPropagationUnassigned}($\ass$, $\sgl$, $\Delta$)\\
  \If{$\sigma$ is of $\mathbf{T}v$}
  {
    $(\ass, \Delta) \leftarrow$ \textsc{UnitPropagationAssigned}($\ass$, $\sgl$, $\Delta$)
  }
  \Return{$(\ass, \Delta)$}
  \caption{\textsc{UnitPropagation}}
  \label{alg:up}
\end{algorithm}

\begin{algorithm}
  \KwIn{An~assignment~$\ass$,
        a~literal~$\sgl \in \ass$,~and
        a~set~of~watched~nogoods~$\Delta$.}
  \KwOut{$\ass$ extended by means of nogood propagation and $\Delta$ with updated watches.}
%  \ForEach{$\delta \in w_{=2}(\Delta, \sigma)$ of form $\{ \sigma, \sigma' \}$}
%  {
%    \If{$\sigma'$ is unassigned in $\mathbf{A}$}
%    {
%      $\mathbf{A} \leftarrow \mathbf{A} \circ \negweak{\sigma'}$
%    }
%  }
  \ForEach{$\delta \in \Delta(\sgl)$}
  {
    \uIf{$\delta$ is violated}
    {
      \Return{$(\text{conflict}, \Delta)$}
    }
    \uElseIf{$\delta$ is weakly unit with $\sgl'$ unassigned}
    {
      $\ass \leftarrow \ass \circ \negweak{\sgl'}$
    }
    \Else%If{there is some unassigned $\sigma' \in \delta$}
    {
      $\Delta(\sgl) \leftarrow \Delta(\sgl) \setminus \{ \delta \}$\\
      Let $\bsgl$, $\bsgl'$ be two unassigned literals in $\delta$.\\
      $\Delta(\bsgl) \leftarrow \Delta(\bsgl) \cup \{ \delta \}$\\
      $\Delta(\bsgl') \leftarrow \Delta(\bsgl') \cup \{ \delta \}$\\
    }
  }
  \Return{$(\ass, \Delta)$}
  \caption{\textsc{UnitPropagationUnassigned}}
  \label{alg:upu}
\end{algorithm}

Algorithm \ref{alg:upu} exhibits how unit propagation is used to infer assignments (of either false or \mbt) from watched nogoods. 
In line 1, the input literal $\sgl$ is transformed to its weak form as lookups in $\Delta$ are always made against the set of nogoods that might propagate in case the literal \mbt, even if $\sgl$ is of $\bT x$. % Why?
In the loop spanning from line 2-13 all nogoods that are to be checked for propagation according to $\Delta$ are iterated. For any such nogood one of the following three cases holds true
\begin{enumerate}
\item it is violated, leading to the algorithm immediately returning the conflicting assignment, or
\item it is weakly unit, in which case a new assignment can be inferred from the nogood, or
\item in any other case, there must be at least two unassigned literals in $\delta$, which are to be watched for changes in assignments.
% TODO: Does not (1.) and not (2.) guarantee that there are two unassigned literals?! Nogood could be satisfied.
\end{enumerate}

In case (3.), $\Delta$ is modified in lines 8-11. As $\sgl$ is now assigned, it should not be watched for changes anymore. This is achieved by removing $\delta$ from the set of watches $\Delta(\sgl)$ and instead adding it to the set of watches for two unassigned literals in $\delta$.

\begin{algorithm}
  \KwIn{An~assignment~$\ass$,
        a~literal~$\sgl \in \ass$, and
        a~watch~structure~$\Delta$.}
  \KwOut{$\ass$ extended by means of nogood propagation.}
%  \ForEach{nogood $\delta \in w_{=2}(\Delta)$ of form $\{ \sigma, \sigma' \}$}
%  {
%    \If{$\sigma'$ is unassigned}
%    {
%      $\mathbf{A} \circ \negstrong{\sigma'}$
%    }
%  }
  \ForEach{nogood $\delta \in \Delta^\alpha(\sgl)$}
  {
  % L statt Theta
    $L \leftarrow \{ \bsgl \ | \ \bsgl \in \delta, \bsgl \not \in \ass \text{, and } \bsgl \ \text{is of form} \ \mathbf{T}v \} \setminus \{ \sgl, \text{head}(\delta) \} $\\
    \uIf{$L \not = \emptyset$}
    {
      $\Delta^\alpha(\sgl) \leftarrow \Delta^\alpha(\sgl) \setminus \{ \delta \}$\\
      Choose $\bsgl \in L$ s.t.~there is no $\bsgl' \in L$ with $\ass = (\ldots, \bsgl, \ldots, \bsgl', \ldots)$.\\
      $\Delta^\alpha(\bsgl) \leftarrow \Delta^\alpha(\bsgl) \cup \{ \delta \}$\\
    }
	\ElseIf{$\delta$ is strictly unit}
	{
	  $\ass \leftarrow \ass \circ \negstrong{\bsgl}$
	}
  }
  \Return{$(\mathbf{A}, \Delta)$}
  \caption{\textsc{UnitPropagationAssigned}}
  \label{alg:upa}
\end{algorithm}

%In order to implement efficient propagation, a data

% No Unfounded Set checks -> MBT.

% Explain 2WL with MBT, propagation with MBT (pseudocode of propagation algorithm).

% Invariant
For every nogood $\delta \in \Delta$, if $\delta$ contains at least two atoms unassigned under $\ass$, then $\delta$ is contained in exactly two watch lists.
%TODO define watch list!

\chapter{Implementation}

\section{Benchmarks}

\chapter{Conclusion}

\section{Related Work}

\section{Conclusion}

\subsection{Related Work}

\backmatter

% Use an optional list of figures.
\listoffigures % Starred version, i.e., \listoffigures*, removes the toc entry.

% Use an optional list of tables.
\listoftables % Starred version, i.e., \listoftables*, removes the toc entry.

% Use an optional list of alogrithms.
\listofalgorithms
\addcontentsline{toc}{chapter}{List of Algorithms}

% Add an index.
\printindex

% Add a glossary.
\printglossaries

% Add a bibliography.
\bibliographystyle{alpha}
\bibliography{thesis}

\end{document}
